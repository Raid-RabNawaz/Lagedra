upstream api      { server api:8080; }
upstream web      { server web:5173; }
upstream admin    { server admin:5173; }
upstream marketing { server marketing:3000; }

# ─── Rate limiting zones ─────────────────────────────────────────────────────
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;

server {
    listen 80;
    server_name _;

    client_max_body_size 25M;

    # ─── Security headers ────────────────────────────────────────────────────
    add_header X-Frame-Options          "SAMEORIGIN"            always;
    add_header X-Content-Type-Options   "nosniff"               always;
    add_header Referrer-Policy          "strict-origin"         always;
    add_header X-XSS-Protection         "1; mode=block"         always;
    add_header Permissions-Policy       "geolocation=(), camera=()" always;

    # ─── API ─────────────────────────────────────────────────────────────────
    location /api/ {
        limit_req zone=api_limit burst=50 nodelay;
        proxy_pass         http://api;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 30s;
    }

    # ─── Auth endpoints (tighter rate limit) ─────────────────────────────────
    location /api/v1/auth/ {
        limit_req zone=auth_limit burst=10 nodelay;
        proxy_pass         http://api;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # ─── Swagger (dev only — block in prod) ──────────────────────────────────
    location /swagger {
        proxy_pass         http://api;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
    }

    # ─── Marketing site (SEO pages, blog) ────────────────────────────────────
    location ~ ^/(blog|how-it-works|pricing|about|contact|faq|legal|sitemap\.xml|robots\.txt|rss\.xml) {
        proxy_pass         http://marketing;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
    }

    # ─── Admin app (served from /admin path prefix) ───────────────────────────
    location /admin {
        proxy_pass         http://admin;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
    }

    # ─── Web app (everything else) ────────────────────────────────────────────
    location / {
        proxy_pass         http://web;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
    }

    # ─── Health check ────────────────────────────────────────────────────────
    location /nginx-health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
